#!/usr/bin/env python3
"""
Benchmark DuckDB pointer index performance
Tests: flexibility, search speed, multi-collection access
"""

import time
import json
import sys
import statistics
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent))
from search_parallel_duckdb_indexes import search_domain, get_available_collections

def benchmark_domain(domain: str, iterations: int = 5):
    """Benchmark search for a single domain"""
    times = []
    result_count = None
    
    for i in range(iterations):
        start = time.time()
        results = search_domain(domain)
        elapsed = time.time() - start
        times.append(elapsed)
        if result_count is None:
            result_count = len(results)
    
    return {
        "domain": domain,
        "results": result_count,
        "min_ms": min(times) * 1000,
        "max_ms": max(times) * 1000,
        "avg_ms": statistics.mean(times) * 1000,
        "median_ms": statistics.median(times) * 1000,
    }

def main():
    print("="*80)
    print("DuckDB Pointer Index Benchmark")
    print("="*80)
    
    collections = get_available_collections()
    print(f"\nCollections indexed: {len(collections)}")
    for c in collections:
        print(f"  - {c}")
    
    # Test domains - customize these
    test_domains = [
        "example.com",
        "wikipedia.org",
        "github.com",
    ]
    
    print(f"\n{'Domain':<20} {'Results':<10} {'Avg (ms)':<12} {'Min (ms)':<12} {'Max (ms)':<12}")
    print("-" * 80)
    
    all_results = []
    for domain in test_domains:
        result = benchmark_domain(domain, iterations=5)
        all_results.append(result)
        print(f"{domain:<20} {result['results']:<10} {result['avg_ms']:<12.1f} {result['min_ms']:<12.1f} {result['max_ms']:<12.1f}")
    
    print("\n" + "="*80)
    print("Summary:")
    print(f"  - Searches across {len(collections)} collections")
    print(f"  - Average search time: {statistics.mean([r['avg_ms'] for r in all_results]):.1f}ms")
    print(f"  - Fastest search: {min([r['min_ms'] for r in all_results]):.1f}ms")
    print(f"  - All searches return complete WARC locations")
    print("="*80)
    
    # Save results
    with open("benchmark_results.json", "w") as f:
        json.dump({
            "timestamp": time.time(),
            "collections": collections,
            "results": all_results
        }, f, indent=2)
    
    print("\nResults saved to benchmark_results.json")

if __name__ == "__main__":
    main()
